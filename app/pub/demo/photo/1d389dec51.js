/*!
 * @packet demo.photo.canvas;
 */
var factory=$.adapt();factory.def({name:"DisplayObject",init:function(t){t.init&&t.init.call(this,t),this._id=t.id,this._x=$.is.isAvalid(t.x)?t.x:0,this._y=$.is.isAvalid(t.y)?t.y:0,this._originalx=this._x,this._originaly=this._y,this._width=$.is.isAvalid(t.width)?t.width:10,this._height=$.is.isAvalid(t.height)?t.height:10,this._rotate=$.is.isAvalid(t.rotate)?t.rotate:0,this._alpha=$.is.isAvalid(t.alpha)?t.alpha:1;var i=document.createElement("canvas");i.width=this._width,i.height=this._height,this.canvas=i,this.ctx=i.getContext("2d"),this._minx=this._x,this._miny=this._y,this._maxwidth=this._width,this._maxheight=this._height,this.cache={}},id:function(t){return 0===arguments.length?this._id:(this._id=t,this)},props:function(t){for(var i in t)this["_"+i]&&(this["_"+i]=t[i]);return this.redraw(),this},render:function(){},redraw:function(){for(var t=this._parent;t;)t.draw(),t=t._parent},_clear:function(){}}).def({name:"DisplayEvent",init:function(t){this.eventType=t.type,this.target=null,this.currentTarget=null,this.data=t.data||null,this._goon=!0},stopPropagation:function(){this._goon=!1}}).def({name:"MouseEvent",extend:"DisplayEvent",init:function(t){this.pageX=t.pageX||0,this.pageY=t.pageY||0}}).def({name:"Sprite",extend:"DisplayObject",init:function(t){this._handler={},this._parent=null,this._root=null,this._depth=0,this._rotatepoint=t.rotatepoint||[0,0],this._scale=1,this._event=t.event===!1?!1:!0;for(var i in t)/^on/.test(i)&&$.is.isFunction(t[i])&&(this[i]=t[i])},root:function(){if(!this._root){for(var t=this;!t.typeOf("root");)t=t._parent;this._root=t}return this._root},parent:function(){return this._parent},x:function(t){return 0===arguments.length?this._x:(this._x=t,this._originalx=t,this.redraw(),this)},y:function(t){return 0===arguments.length?this._y:(this._y=t,this._originaly=t,this.redraw(),this)},width:function(t){return 0===arguments.length?this._width:(this._width=t,this.redraw(),this)},height:function(t){return 0===arguments.length?this._height:(this._height=t,this.redraw(),this)},alpha:function(t){return 0===arguments.length?this._alpha:(this._alpha=t,this.redraw(),this)},rotate:function(t){if(1===arguments.length&&$.is.isNumber(t)){this._rotate=t;var i=Math.PI*(t/180),e=this._rotatepoint,h=this._originalx,n=this._originaly;if(0!==e[1]){var r=Math.sqrt((e[0]-h)*(e[0]-h)+(e[1]-n)*(e[1]-n)),a=Math.PI-Math.atan((e[1]-n)/(e[0]-h))-i;this._x=e[0]+r*Math.cos(a),this._y=e[1]-r*Math.sin(a)}else this._x=h,this._y=n;return this.redraw(),this}return this._rotate},rotatePoint:function(t,i){return 0===arguments.length?this._rotatepoint:(this._rotatepoint=[t,i],this)},checkPointIn:function(t,i){return t>=0&&t<=0+this._width&&i>=0&&i<=0+this._height},getLocalRelativeParentPoint:function(t,i){var e=this,h=Math.PI*(e._rotate/180),n=Math.cos(h),r=Math.sin(h),a=t-e._x,s=i-e._y;return{x:a*n+s*r,y:s*n-a*r}},getLocalRelativeRootPoint:function(t,i){for(var e=[],h=this._parent;h;)e.push(h),h=h._parent;for(var n={x:0,y:0},r=e.length-1;r>=0;--r)n=e[r].getLocalRelativeParentPoint(t,i);return n},clean:function(){this.ctx.clearRect(0,0,this._width,this._height)},addEventListenter:function(t,i){return this._handler[t]?this._handler[t]=[i]:this._handler[t].push(i),this},removeEventListener:function(t,i){if(this._handler[t])if(i){var e=this._handler[t].indexOf(i);-1!==e&&this._handler[t].splice(e,1)}else this._handler[t].length=0;return this},dispatchEvent:function(t){t.target=this;for(var i=this;i&&(i.privator("triggerEvent",t),t._goon);)i=i._parent;return this},getImageDate:function(t,i,e,h){var n=t||0,r=i||0,a=e||this._width,s=h||this._height,o=document.createElement("canvas"),c=o.getContext("2d");return o.width=a,o.height=s,c.drawImage(this.ctx.canvas,n,r,a,s,0,0,a,s),o.toDataURL("image/png")},_triggerEvent:function(t){if(t.currentTarget=this,this._handler[t.eventType])for(var i=0;i<this._handler[t.eventType].length;i++)this._handler[t.eventType][i].call(this,t);else $.is.isFunction(this["on"+t.eventType])&&this["on"+t.eventType].call(this,t);return this}}).def({name:"DisplayObjectContainer",extend:"Sprite",init:function(){this.children=[]},addChild:function(t){if(t.typeOf&&t.typeOf("DisplayObject"))this.children.push(t),t._depth=this.children.length,t._parent=this,t._root=this.typeOf("root")?this:this._root;else if($.is.isObject(t)&&t.displayType){var i=factory.create(t.displayType,t);this.children.push(i),i._depth=this.children.length,i._parent=this,i._root="ROOT"===this._id?this:this._parent}return this.render(),this},getChildAt:function(t){return t>=0&&t<this.children.length?this.children[t]:null},getChildById:function(t){var i=null;if(t&&""!==t)for(var e=0;e<this.children.length;e++)this.children[e]._id===t&&(i=this.children[e]);return i},removeChildAt:function(t){return t>=0&&t<this.children.length&&(this.children.splice(t,1),this.render()),this},render:function(){var t=this;this.clean(),t.ctx.globalAlpha=t._alpha,this.children.forEach(function(i){t.ctx.save(),i.render(),i.typeOf("DisplayObjectContainer")?(t.ctx.translate(i._x,i._y),t.ctx.rotate(i._rotate/180*Math.PI),t.ctx.drawImage(i.canvas,0,0,i._width,i._height)):(t.ctx.translate(i._x,i._y),t.ctx.rotate(i._rotate/180*Math.PI),t.ctx.drawImage(i.canvas,0,0,i._width,i._height)),t.ctx.restore()})},draw:function(){var t=this;this.clean(),t.ctx.globalAlpha=t._alpha,this.children.forEach(function(i){t.ctx.save(),i.typeOf("DisplayObjectContainer")?(t.ctx.translate(i._x,i._y),t.ctx.rotate(i._rotate/180*Math.PI),t.ctx.drawImage(i.canvas,0,0,i._width,i._height)):(t.ctx.translate(i._x,i._y),t.ctx.rotate(i._rotate/180*Math.PI),t.ctx.drawImage(i.canvas,0,0,i._width,i._height)),t.ctx.restore()})},setdrawingsize:function(){var t=0,i=this._width,e=this._height,h=0,n=this._width,r=this._height;for(var a in this.children)this.children[a]._x<0&&this.children[a]._x<t&&(t=this.children[a]._x),this.children[a]._x>i&&(i=this.children[a]._x),i+=200,this.children[a]._y>e&&(e=this.children[a]._y),e+=200,this.children[a]._y<0&&this.children[a]._y<h&&(h=this.children[a]._y),this.children[a]._width>n&&(n=this.children[a]._width),this.children[a]._height>r&&(r=this.children[a]._height);this._minx=this._x-Math.abs(t),this._miny=this._y-Math.abs(h),this._maxwidth=Math.abs(t)+n+(i-this._width),this._maxheight=Math.abs(h)+r+(e-this._height),this.canvas.width=this._maxwidth,this.canvas.height=this._maxheight},clean:function(){this.ctx.clearRect(0,0,this._maxwidth,this._maxheight)},_target:function(t,i){for(var e=this,h=this.children.length-1;h>=0;--h){var n=this.children[h];if(n._event){var r=n.getLocalRelativeParentPoint(t,i);if(n.checkPointIn(r.x,r.y)){e=n.typeOf("DisplayObjectContainer")?n.privator("target",r.x,r.y):n;break}}}return e}}).def({name:"Animate",extend:"DisplayObjectContainer",init:function(){var t=this;this._interval=setInterval(function(){t.onenterframe&&t.onenterframe()},50)},_clear:function(){for(var t in this)this[t]=null;clearInterval(this._interval)}}).def({name:"SquartDisplay",extend:"Sprite",init:function(t){this.backgroundColor=t.backgroundColor||null,this.borderSize=t.borderSize||null,this.borderColor=t.borderColor||null},render:function(){this.ctx.globalAlpha=this._alpha,this.backgroundColor&&(this.ctx.save(),this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this._width,this._height),this.ctx.restore()),(this.borderSize||this.borderColor)&&(this.ctx.save(),this.ctx.lineWidth=this.borderSize,this.ctx.strokeStyle=this.borderColor,this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(0,this._height),this.ctx.lineTo(this._width,this._height),this.ctx.lineTo(this._width,0),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore())}}).def({name:"ImageDisplay",extend:"Sprite",init:function(t){this.image=t.image,this.imageType=t.imageType,this.backgroundColor=t.backgroundColor||null},render:function(){if(this.ctx.globalAlpha=this._alpha,this.backgroundColor&&(this.ctx.save(),this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this._width,this._height),this.ctx.restore()),this.image){var t=this.image,i=this.imageType?this.imageType:"fit",e=this;if("fit"===i){var h,n=0,r=0,a=0;t.width>e._width?(n=e._width,h=t.height/t.width*n,h>e._height&&(h=e._height,n=t.width/t.height*h)):(h=e._height,n=t.width/t.height*h,n>e._width&&(n=e._width,h=t.height/t.width*n)),r=(e._width-n)/2,a=(e._height-h)/2,e.ctx.drawImage(t,r,a,n,h)}else if("repeat"===i){for(var n=e._width,h=e._height,r=0,a=0;;)if(e.ctx.drawImage(t,r,a,t.width,t.height),r+=t.width,r>n){if(a+=t.height,!(h>a))break;r=0}}else if("fill"===i)e.ctx.drawImage(t,0,0,e._width,e._height);else if("center"===i){var n=t.width,h=t.height,r=0,a=0;r=(e._width-n)/2,a=(e._height-h)/2,e.ctx.drawImage(t,r,a,n,h)}}},setImage:function(t,i){return this.image=t,this.imageType=i||"fit",this.render(),this.redraw(),this}}).def({name:"root",extend:"DisplayObjectContainer",init:function(t){this._parent=null,this._root=null,this._id="ROOT";var i=this;$(this.canvas).appendTo(t.dom).click(function(t){var e=t.pageX-$(this).offset().left,h=t.pageY-$(this).offset().top,n=i.privator("target",e,h);n.dispatchEvent(factory.create("MouseEvent",{type:"click",pageX:e,pageY:h}))}).bind("mousedown",function(t){var e=t.pageX-$(this).offset().left,h=t.pageY-$(this).offset().top,n=i.privator("target",e,h);n.dispatchEvent(factory.create("MouseEvent",{type:"mousedown",pageX:e,pageY:h}))}).bind("mouseup",function(t){var e=t.pageX-$(this).offset().left,h=t.pageY-$(this).offset().top,n=i.privator("target",e,h);n.dispatchEvent(factory.create("MouseEvent",{type:"mouseup",pageX:e,pageY:h}))}).bind("mousemove",function(t){var e=t.pageX-$(this).offset().left,h=t.pageY-$(this).offset().top,n=i.privator("target",e,h);n.dispatchEvent(factory.create("MouseEvent",{type:"mousemove",pageX:e,pageY:h}))})}}),$.fn.display=function(t){var i={width:$(this).width(),height:$(this).height(),dom:$(this)};return factory.create("root",$.extend(i,t))},module.exports={create:function(t,i){return factory.create(t,i)},def:function(t){return factory.def(t)},factory:function(){return factory}};