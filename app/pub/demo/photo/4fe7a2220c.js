/*!
 * @packet demo.photo.photo;
 * @require demo.photo.canvas;
 * @require demo.photo.file;
 * @css demo.photo.style.photocutter;
 */
Module({name:"photocutter",className:"photocutter",extend:"view",option:{filename:"file",url:"",picWidth:100,picHeight:100,type:".png,.gif,.jpg,.jpeg",rotateoffset:10,zoomoffset:.2,tools:[{type:"zoomin",icon:"fa-zoom-in"},{type:"zoomout",icon:"fa-zoom-out"},{type:"rotateleft",icon:"fa-undo"},{type:"rotateright",icon:"fa-redo"},{type:"download",icon:"fa-download"},{type:"reset",icon:"fa-spinner11"}]},init:function(t){var i=this,e=require("@canvas");t.sceneWidth=this.dom.width(),t.sceneHeight=this.dom.height()-30;var h=this.dom.display(),o=e.create("DisplayObjectContainer",{id:"aa",width:t.sceneWidth,height:t.sceneHeight,x:0,y:0}),s=Math.sqrt(t.sceneWidth*t.sceneWidth+t.sceneHeight*t.sceneHeight),n=e.create("DisplayObjectContainer",{id:"imageContainer",width:s,height:s,x:-(s-t.sceneWidth)/2,y:-(s-t.sceneHeight)/2,init:function(){this.ismove=!1,this.cleft=0,this.ctop=0},onmousedown:function(t){var i=this.getChildAt(0),e=i.getLocalRelativeRootPoint(t.pageX,t.pageY);this.cleft=e.x-i.x(),this.ctop=e.y-i.y()},onmousemove:function(t){if(this.ismove){var i=this.getChildAt(0),e=i.getLocalRelativeRootPoint(t.pageX,t.pageY),h=e.x-this.cleft,o=e.y-this.ctop;(this.getChildAt(0).width()>this.getChildAt(1).width()||this.getChildAt(0).height()>this.getChildAt(1).height())&&(h<this.getChildAt(1).x()?h>this.getChildAt(1).x()-(this.getChildAt(0).width()-this.getChildAt(1).width())?i.x(e.x-this.cleft):i.x(this.getChildAt(1).x()-(this.getChildAt(0).width()-this.getChildAt(1).width())):i.x(this.getChildAt(1).x()),o<this.getChildAt(1).y()?o>this.getChildAt(1).y()-(this.getChildAt(0).height()-this.getChildAt(1).height())?i.y(e.y-this.ctop):i.y(this.getChildAt(1).y()-(this.getChildAt(0).height()-this.getChildAt(1).height())):i.y(this.getChildAt(1).y()))}},onmouseup:function(){this.ismove=!1}});n.rotatePoint(t.sceneWidth/2,t.sceneHeight/2);var a=e.create("ImageDisplay",{id:"image",width:t.sceneWidth,height:t.sceneHeight,x:(s-t.sceneWidth)/2,y:(s-t.sceneHeight)/2,rotate:0,onmousedown:function(){this.parent().ismove=!0}});a.rotatePoint((s-t.sceneWidth)/2,(s-t.sceneHeight)/2);var d=e.create("SquartDisplay",{id:"squart",width:t.picWidth,height:t.picHeight,x:(s-t.picWidth)/2,y:(s-t.picHeight)/2,onmousedown:function(){this.parent().ismove=!0}}),g=e.create("DisplayObjectContainer",{id:"squart",width:t.sceneWidth,height:t.sceneHeight,x:0,y:0,alpha:.6,event:!1,backgroundColor:"rgba(36,33,33,1)"}),c=e.create("SquartDisplay",{id:"squart",width:(t.sceneWidth-t.picWidth)/2,height:t.sceneHeight,x:0,y:0,backgroundColor:"rgba(36,33,33,1)"}),r=e.create("SquartDisplay",{id:"squart",width:t.picWidth,height:(t.sceneHeight-t.picHeight)/2,x:(t.sceneWidth-t.picWidth)/2,y:0,backgroundColor:"rgba(36,33,33,1)"}),l=e.create("SquartDisplay",{id:"squart",width:(t.sceneWidth-t.picWidth)/2,height:t.sceneHeight,x:(t.sceneWidth-t.picWidth)/2+t.picWidth,y:0,backgroundColor:"rgba(36,33,33,1)"}),p=e.create("SquartDisplay",{id:"squart",width:t.picWidth,height:(t.sceneHeight-t.picHeight)/2,x:(t.sceneWidth-t.picWidth)/2,y:(t.sceneHeight-t.picHeight)/2+t.picHeight,backgroundColor:"rgba(36,33,33,1)"}),f=e.create("SquartDisplay",{id:"squart",width:t.picWidth,height:t.picHeight,x:(t.sceneWidth-t.picWidth)/2,y:(t.sceneHeight-t.picHeight)/2,borderSize:3,borderColor:"white"});g.addChild(c).addChild(r).addChild(l).addChild(p).addChild(f),n.addChild(a).addChild(d),o.addChild(n),h.addChild(o),h.addChild(g),this.image=a,this.imageContainer=n,this.baseContainer=o,this.r=s;var m="<div class='tools'>";for(var u in t.tools)m+="<div class='tbtn' type='"+t.tools[u].type+"'><i class='fa "+t.tools[u].icon+"'></i></div>";m+="<div class='fbtn'><i class='fa fa-folder-open'></i><input type='file' accept='"+t.type+"'></div>",m+="</div>";var C=$(m).appendTo(this.dom);C.find(".tbtn").each(function(){$(this).click(function(){var t=$(this).attr("type");i.dispatchEvent(t,{btn:$(this)})})}),C.find("input").bind("change",function(t){var e=t.target.files||t.dataTransfer.files;i.setImage(e)}),$("<div class='mask'><div class='openfile'>Open Image<input type='file' accept='"+t.type+"'></div></div>").appendTo(this.dom).find("input").bind("change",function(t){var e=t.target.files||t.dataTransfer.files;e.length>0&&(i.dom.find(".mask").remove(),i.setImage(e))})},setImage:function(t){var i=this.image,e=this;if(t.length>0){var h=require("@file"),o=h.set(t[0]);o.getImage(function(t){var h=t,o=h.width,s=h.height;i.canvas.width=o,i.canvas.height=s,i.props({width:o,height:s,x:(e.r-o)/2,y:(e.r-s)/2,rotate:0}),i.setImage(t,"fit"),e.imageContainer.rotate(0)})}},zoomIn:function(){var t=this.image,i=this.option.zoomoffset,e=t.width()+t.width()*i;e/t.image.width<=5&&t.props({width:e,height:t.height()+t.height()*i,x:t.x()-t.width()*i/2,y:t.y()-t.height()*i/2})},zoomOut:function(){var t=this.image,i=this.option.zoomoffset,e=t.width()-t.width()*i,h=t.height()-t.height()*i;e<this.option.picWidth&&(e=this.option.picWidth,h=t.height()/t.width()*e,h<this.option.picHeight&&(h=this.option.picHeight,e=t.width()/t.height()*h)),h<this.option.picHeight&&(h=this.option.picHeight,e=t.width()/t.height()*h,e<this.option.picWidth&&(e=this.option.picWidth,h=t.height()/t.width()*e));var o=t.x()+t.width()*i/2,s=t.y()+t.height()*i/2,n=this.imageContainer;o<n.getChildAt(1).x()?o>n.getChildAt(1).x()-(n.getChildAt(0).width()-n.getChildAt(1).width())||(o=n.getChildAt(1).x()-(n.getChildAt(0).width()-n.getChildAt(1).width())):o=n.getChildAt(1).x(),s<n.getChildAt(1).y()?s>n.getChildAt(1).y()-(n.getChildAt(0).height()-n.getChildAt(1).height())||(s=n.getChildAt(1).y()-(n.getChildAt(0).height()-n.getChildAt(1).height())):s=n.getChildAt(1).y(),e+o<n.getChildAt(1).x()+n.getChildAt(1).width()&&(o=n.getChildAt(1).x()+n.getChildAt(1).width()-e),h+s<n.getChildAt(1).y()+n.getChildAt(1).height()&&(s=n.getChildAt(1).y()+n.getChildAt(1).height()-h),t.props({width:e,height:h,x:o,y:s})},rotateRight:function(){this.imageContainer.rotate(this.imageContainer.rotate()+this.option.rotateoffset)},rotateLeft:function(){this.imageContainer.rotate(this.imageContainer.rotate()-this.option.rotateoffset)},download:function(){var t=this.option,i=this.baseContainer.getImageDate((t.sceneWidth-t.picWidth)/2,(t.sceneHeight-t.picHeight)/2,t.picWidth,t.picHeight),e=require("@file"),h=e.getBlobFromURI(i);e.saveAs(h,"photocutter.png")},reset:function(){var t=this.image.image,i=t.width,e=t.height;this.image.props({width:i,height:e,x:(this.r-i)/2,y:(this.r-e)/2,rotate:0}),this.imageContainer.rotate(0)},upload:function(){var t=this.option,i=this.baseContainer.getImageDate((t.sceneWidth-t.picWidth)/2,(t.sceneHeight-t.picHeight)/2,t.picWidth,t.picHeight),e=require("@file"),h=e.getBlobFromURI(i),o=new FormData;o.append(t.name,h),$.ajax({url:t.url||null,data:o,method:"post",dataType:"json",handlers:{load:function(t){},progress:function(t){},error:function(t){}}})},event_zoomin:function(){this.zoomIn()},event_zoomout:function(){this.zoomOut()},event_rotateleft:function(){this.rotateLeft()},event_rotateright:function(){this.rotateRight()},event_download:function(){this.download()},event_reset:function(){this.reset()}}),Module({name:"gallery",className:"gallery",extend:"view",option:{url:"gallery.json",rotateoffset:10,zoomoffset:.2,showList:!1,tools:[{type:"zoomin",icon:"fa-zoom-in"},{type:"zoomout",icon:"fa-zoom-out"},{type:"rotateleft",icon:"fa-undo"},{type:"rotateright",icon:"fa-redo"},{type:"download",icon:"fa-download"},{type:"reset",icon:"fa-spinner11"},{type:"previmage",icon:"fa-arrow-left2"},{type:"nextimage",icon:"fa-arrow-right2"}]},init:function(t){t.sceneWidth=this.dom.width(),t.sceneHeight=this.dom.height();var i=require("@canvas");this.dom.width(t.sceneWidth).height(t.sceneHeight);var e=this.dom.display(),h=i.create("DisplayObjectContainer",{id:"aa",width:t.sceneWidth,height:t.sceneHeight,x:0,y:0}),o=Math.sqrt(t.sceneWidth*t.sceneWidth+t.sceneHeight*t.sceneHeight),s=i.create("DisplayObjectContainer",{id:"imageContainer",width:o,height:o,x:-(o-t.sceneWidth)/2,y:-(o-t.sceneHeight)/2,init:function(){this.ismove=!1,this.cleft=0,this.ctop=0},onmousedown:function(t){var i=this.getChildAt(0),e=i.getLocalRelativeRootPoint(t.pageX,t.pageY);this.cleft=e.x-i.x(),this.ctop=e.y-i.y()},onmousemove:function(t){if(this.ismove&&(this.getChildAt(0).width()>this.getChildAt(1).width()||this.getChildAt(0).height()>this.getChildAt(1).height())){var i=this.getChildAt(0),e=i.getLocalRelativeRootPoint(t.pageX,t.pageY),h=e.x-this.cleft,o=e.y-this.ctop;h<this.getChildAt(1).x()?h>this.getChildAt(1).x()-(this.getChildAt(0).width()-this.getChildAt(1).width())?i.x(e.x-this.cleft):i.x(this.getChildAt(1).x()-(this.getChildAt(0).width()-this.getChildAt(1).width())):i.x(this.getChildAt(1).x()),o<this.getChildAt(1).y()?o>this.getChildAt(1).y()-(this.getChildAt(0).height()-this.getChildAt(1).height())?i.y(e.y-this.ctop):i.y(this.getChildAt(1).y()-(this.getChildAt(0).height()-this.getChildAt(1).height())):i.y(this.getChildAt(1).y())}},onmouseup:function(){this.ismove=!1}});s.rotatePoint(t.sceneWidth/2,t.sceneHeight/2);var n=i.create("ImageDisplay",{id:"image",width:t.sceneWidth,height:t.sceneHeight,x:(o-t.sceneWidth)/2,y:(o-t.sceneHeight)/2,rotate:0});n.rotatePoint((o-t.sceneWidth)/2,(o-t.sceneHeight)/2);var a=i.create("SquartDisplay",{id:"squart",width:t.sceneWidth,height:t.sceneHeight,x:(o-t.sceneWidth)/2,y:(o-t.sceneHeight)/2,onmousedown:function(){this.parent().ismove=!0}});s.addChild(n).addChild(a),h.addChild(s),e.addChild(h),this.image=n,this.imageContainer=s,this.baseContainer=h,this.r=o,$("<div class='desccon'></div>").appendTo(this.dom),$("<div class='thumbs'><div class='bar'><i class='fa fa-arrow-right2'></i></div><div class='listcon'><div class='list'></div></div></div>").appendTo(this.dom).find(".bar").click(function(){r.dom.toggleClass("close")});var d="<div class='tools'>";for(var g in t.tools)d+="<div class='tbtn' type='"+t.tools[g].type+"'><i class='fa "+t.tools[g].icon+"'></i></div>";d+="</div>";var c=$(d).appendTo(this.dom),r=this;c.find(".tbtn").each(function(){$(this).click(function(){var t=$(this).attr("type");r.dispatchEvent(t,{btn:$(this)})})}),t.showList||this.dom.addClass("close"),this.current=0,this.loading.ths=this,this.getData()},loading:{ths:null,create:function(){0===this.ths.dom.find(".mask").length&&$("<div class='mask'><div class='con'><i class='fa fa-spinner9 fa-spin'></i></div></div>").appendTo(this.ths.dom)},remove:function(){this.ths.dom.find(".mask").remove()},icon:function(t){this.ths.dom.find(".mask i").attr(t)},mask:function(){return this.ths.dom.find(".mask")}},closeList:function(){this.dom.addClass("close")},openList:function(){this.dom.removeClass("close")},getData:function(){this.getRequest(this.option.url).done(function(t){this.setImageList(t)})},setImage:function(t){var i=this;this.loading.create(),$.loader().image(t,function(){i.loading.remove();var t=this,e=t.width,h=t.height,o=i.image;o.canvas.width=e,o.canvas.height=h,o.props({width:e,height:h,x:(i.r-e)/2,y:(i.r-h)/2,rotate:0}),o.setImage(this,"fit"),i.imageContainer.rotate(0)},function(){i.loading.icon("fa fa-spinner9"),i.loading.mask().click(function(){i.setImage(t)})})},_resize:function(){this.dom.find(".list").height()>this.dom.find(".listcon").height()?this.dom.find(".listcon").bind("mousemove",function(t){var i=$(this).children(0).height()-$(this).height(),e=i*(t.pageY-$(this).offset().top)/$(this).height();$(this).scrollTop(e)}):this.dom.find(".listcon").unbind("mousemove")},setImageList:function(t){this.data=t;var i="",e=this;for(var h in t)i+="<div class='img' num='"+h+"'><div class='mg' style='background-image:url("+t[h].thumb+")'></div></div>";this.dom.find(".list").html(i).find(".img").each(function(t,i){$(this).click(function(){$(this).parent().children().each(function(){$(this).removeClass("hover")});var t=$(this).attr("num");$(this).addClass("hover"),e.setImage(e.data[t].big),e.dom.find(".desccon").html(e.data[t].desc||"")}),0===i&&$(this).click()}),this.privator("resize")},zoomIn:function(){var t=this.image,i=this.option.zoomoffset,e=t.width()+t.width()*i;e/t.image.width<=5&&t.props({width:e,height:t.height()+t.height()*i,x:t.x()-t.width()*i/2,y:t.y()-t.height()*i/2})},zoomOut:function(){var t=this.image,i=this.option.zoomoffset,e=this.imageContainer;if(e.getChildAt(0).width()>e.getChildAt(1).width()||e.getChildAt(0).height()>e.getChildAt(1).height()){var h=t.width()-t.width()*i,o=t.height()-t.height()*i;h<this.option.sceneWidth&&(h=this.option.sceneWidth,o=t.height()/t.width()*h,o<this.option.sceneHeight&&(o=this.option.sceneHeight,h=t.width()/t.height()*o)),o<this.option.sceneHeight&&(o=this.option.sceneHeight,h=t.width()/t.height()*o,h<this.option.sceneWidth&&(h=this.option.sceneWidth,o=t.height()/t.width()*h));var s=t.x()+t.width()*i/2,n=t.y()+t.height()*i/2;s<e.getChildAt(1).x()?s>e.getChildAt(1).x()-(e.getChildAt(0).width()-e.getChildAt(1).width())||(s=e.getChildAt(1).x()-(e.getChildAt(0).width()-e.getChildAt(1).width())):s=e.getChildAt(1).x(),n<e.getChildAt(1).y()?n>e.getChildAt(1).y()-(e.getChildAt(0).height()-e.getChildAt(1).height())||(n=e.getChildAt(1).y()-(e.getChildAt(0).height()-e.getChildAt(1).height())):n=e.getChildAt(1).y(),h+s<e.getChildAt(1).x()+e.getChildAt(1).width()&&(s=e.getChildAt(1).x()+e.getChildAt(1).width()-h),o+n<e.getChildAt(1).y()+e.getChildAt(1).height()&&(n=e.getChildAt(1).y()+e.getChildAt(1).height()-o),t.props({width:h,height:o,x:s,y:n})}},rotateRight:function(){this.imageContainer.rotate(this.imageContainer.rotate()+this.option.rotateoffset)},rotateLeft:function(){this.imageContainer.rotate(this.imageContainer.rotate()-this.option.rotateoffset)},download:function(){this.option;try{var t=this.image.getImageDate(0,0,this.image.image.width,this.image.image.height),i=require("@file"),e=i.getBlobFromURI(t);i.saveAs(e,"photocutter.png")}catch(h){console.info("download error")}},reset:function(){var t=this.image.image,i=t.width,e=t.height;this.image.props({width:i,height:e,x:(this.r-i)/2,y:(this.r-e)/2,rotate:0}),this.imageContainer.rotate(0)},gotoImage:function(t){var i=this.dom.find(".img").eq(parseInt(t));i.length>0&&(this.current=t,i.click())},nextImage:function(){var t=this.current+1;this.gotoImage(t)},prevImage:function(){var t=this.current-1;this.gotoImage(t)},event_zoomin:function(){this.zoomIn()},event_zoomout:function(){this.zoomOut()},event_rotateleft:function(){this.rotateLeft()},event_rotateright:function(){this.rotateRight()},event_reset:function(){this.reset()},event_download:function(){this.download()},event_nextimage:function(){this.nextImage()},event_previmage:function(){this.prevImage()}});